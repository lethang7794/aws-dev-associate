# Tutorial Dojo - DVA-C02 - Timed Mode Set 1

## Domain 1: Development with AWS Services

| No    | Q                                                                                                  | A                                                                                                                                         | Ref                                                       |
| ----- | -------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------- |
| 1     | Improve performace of S3 upload                                                                    | Multipart upload                                                                                                                          |                                                           |
| 2     | Caching: Lazy-load & Writethrough                                                                  |                                                                                                                                           |                                                           |
| 3     | Lambda: Different parameter depends on environemnt                                                 | Environment variable (# Stage variable)                                                                                                   |                                                           |
| 4 ‚ùå  | AWS SAM: shift traffic to new version                                                              | SAM Deloyment strategy                                                                                                                    | [SAM - Deploying gradually]                               |
|       |                                                                                                    | - `AllAtOnce` (1 deploy)                                                                                                                  |                                                           |
|       |                                                                                                    | - `Canary` 10% 5, 10, 15, 30 min (2 deploys)                                                                                              |                                                           |
|       |                                                                                                    | - `Linear` 10% Every 1, 2, 3, 10 min                                                                                                      |                                                           |
|       |                                                                                                    |                                                                                                                                           |                                                           |
| 5     | API Gateway: same API Gateway for multiple environments                                            | Stage variable                                                                                                                            |                                                           |
| 6     | CloudWatch Alarm: When to alarm?                                                                   | `Period` / `Evaluation Periods` / `Data points to Alarm`                                                                                  |                                                           |
| 7     | SAM: Nested application                                                                            | `AWS::Serverless::Application`                                                                                                            |                                                           |
| 8     | Lambda deploy: Graduate increase traffic to new version                                            | Lambda supports traffic shifting for aliases (by setting `traffic weight`). (That's why SAM have `canary`, `linear` deployment strategy ) |                                                           |
| 9     | API Gateway: Map data for microservice (in container)                                              | Use `HTTP` integration (Not `AWS` or `_PROXY`)                                                                                            |                                                           |
| 10    | Database scale globally, handle frequent schema changes                                            | DynamoDB (not Aurora)                                                                                                                     |                                                           |
| 11    | API Gateway - TTL 300s. How client can invalidate cache?                                           | Send request with `Cache-Control: max-age=0` header                                                                                       |                                                           |
| 12 ‚ùå | Lambda: Reponse to user after 5 min                                                                | Lambda `Invoke` API `InvocationType`                                                                                                      | [Invoke - InvocationType]                                 |
|       |                                                                                                    | - `RequestResponse`: Synchranous invocation                                                                                               |                                                           |
|       |                                                                                                    | - `Event`: Asynchronous invocation                                                                                                        |                                                           |
|       |                                                                                                    | - `DryRun`: Validate params/role                                                                                                          |                                                           |
| 13    | Session data store on DynamoDB. Delete session of logged out users?                                | Use DynamoDB TTL (when will an item is eligible for expiration - in epoch time)                                                           |                                                           |
| 14 ‚ùå | S3: Remove PII before return to application                                                        | Use S3 Object Lambda to process object before return to application                                                                       | [S3 Object Lambda] [S3 Object Lambda Use with CloudFront] |
| 15    | Serve content based on location                                                                    | - CloudFront can add header about viewer location's location (based on the viewer's IP address).                                          |                                                           |
|       |                                                                                                    | - Use a CloudFront function to return the URL base on these headers (e.g. `CloudFront-Viewer-Country`)                                    |                                                           |
| 16    | What to do after update Cfn template of a Lambda function?                                         | 1. `aws cloudformation package`: Uploads local artifacts to S3, update Cfn template to reference these artifacts                          |                                                           |
|       |                                                                                                    | 2. `aws cloudformation deploy`: Update (deploy) the Cfn stack                                                                             |                                                           |
| 17    | Multi-thread key-value cache store                                                                 | Elasticache for Memcached                                                                                                                 |                                                           |
| 18 ‚ùå | Only allow authorized clients to invalidate an API Gateway cache                                   | - API Gateway Additional settings / Per-key cache invalidation / Require authorization                                                    | [Invalidate an API Gateway cache entry]                   |
|       |                                                                                                    | - Client send request with `Cache-Control: max-age=0` header.                                                                             |                                                           |
| 19    | Process long-running tasks                                                                         | Elastic Beanstalk worker environment (an HTTP request handler that EB invokes with an SQS queue)                                          |                                                           |
| 20    | ECS: Where to config port for container?                                                           | Task definition                                                                                                                           |                                                           |
| 21 ‚ùå | Lambda: 50 requests/s; 100 s/request üëâÔ∏è 5.000 concurrency execution                               | Default quota of Lambda concurrency execution: 1.000 (can be increased to 10.000)                                                         |                                                           |
| 22    | Can Lambda handle 10 requests/s (each request take 50s)                                            | 500 concurrent execution (Lambda can handles without doing anything. The default limit is 1.000)                                          |                                                           |
| 23    | DynamoDB table attributes: UserID (PK) - GameTitle (SK) - TopScore. Get max TopScore of each game? | Create a Global Secondary Index: GameTitle (PK) - TopScore (SK). Query 1 item for each game in descending order.                          |                                                           |
| 24    | Kinesis Data Streams: How many worker is optimal to process a number of shards?                    | 1:1 ratio                                                                                                                                 |                                                           |
| 25    | AWS CLI timeout when list bucket with 10.000 objects                                               | Add pagination pararemter when use AWS CLI                                                                                                |                                                           |
| 26    | Perrmision to Create/Detete GitCommit repos                                                        | `codecommit:CreateRepository` & `codecommit:DeleteRepository`                                                                             |                                                           |
| 27    | DynamoDB Streams: Send a copy of old item to S3                                                    | `StreamViewType`: `OLD_IMAGE`                                                                                                             |                                                           |

[SAM - Deploying gradually]: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/automating-updates-to-serverless-apps.html
[Invoke - InvocationType]: https://docs.aws.amazon.com/lambda/latest/dg/API_Invoke.html#SSS-Invoke-request-InvocationType
[S3 Object Lambda]: https://aws.amazon.com/blogs/aws/introducing-amazon-s3-object-lambda-use-your-code-to-process-data-as-it-is-being-retrieved-from-s3/
[S3 Object Lambda Use with CloudFront]: https://aws.amazon.com/blogs/aws/new-use-amazon-s3-object-lambda-with-amazon-cloudfront-to-tailor-content-for-end-users/
[Invalidate an API Gateway cache entry]: https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-caching.html#invalidate-method-caching

## Domain 2: Security

| No   | Q                                                               | A                                                                                                                               | Ref                                                |
| ---- | --------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------- |
| 1 ‚ùå | Give a program to AWS services                                  | - Best practice: EC2 instance role                                                                                              |                                                    |
|      |                                                                 | - On premise: Long-term credential                                                                                              |                                                    |
| 2    | Share DB endpoint                                               | Use System Manager Parameter Store secure string                                                                                |                                                    |
| 3 ‚ùå | Database credential - How to encrypt & auto rotate?             | - AWS Secret Manager + Enable auto rotate                                                                                       |                                                    |
|      |                                                                 | - IAM DB Authentication: Authenticate connection with IAM                                                                       |                                                    |
| 4    | API Gateway: Allow another account invoke via IAM Role          | 1. From the other account, grant permission to interact with this API Gateway                                                   | [Managing access to API Gateway]                   |
|      |                                                                 | 2. From this account, attach a resource-policy to API Gateway that grant the IAM role from other account permission to invoke   | [Allow roles in another AWS account to use an API] |
| 5    | Grant permission to access only some path of a S3 bucket        | Use S3 bucket policy, with the policy statement `Resource` including the path                                                   |                                                    |
| 6    | Login with social site: Facebook..., then access to AWS service | Cognito Identiy Pool (Federated Identity)                                                                                       |                                                    |
| 7    | S3 - Encrypt AE256                                              | `x-amz-server-side-encryption: AE256`                                                                                           |                                                    |
| 8 ‚ùå | S3 - Ensure all objects are encryption at rest with SSE-KMS     | Add a bucket policy which denies any s3:PutObject action unless the request includes the `x-amz-server-side-encryption` header. |                                                    |
| 9    | KMS - Generate data key but not use immediately                 | `GenerateDataKeyWithoutPlaintext`                                                                                               |                                                    |

[Managing access to API Gateway]: https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-control-access-to-api.html
[Allow roles in another AWS account to use an API]: https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies-examples.html#apigateway-resource-policies-cross-account-example

## Domain 3: Deployment

| No   | Q                                                                    | A                                                                                         | Ref                                |
| ---- | -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- | ---------------------------------- |
| 1 ‚ùå | Implement subscription with API Gateway                              | Use usage plan to distribute APIs & throttle usages based on defined limit/quota          | [API Gateway - Usage plan]         |
| 2 ‚ùå | Lambda, pause task & wait for external process                       | Step Function - Callback pattern (SQS + SNS + Lambda)                                     | [Step Function - Callback Pattern] |
|      |                                                                      | - waitForTaskToken                                                                        |                                    |
|      |                                                                      | - SendTaskSuccess (with the task token)                                                   |                                    |
| 3    | Deploy Lambda with CodeDeploy                                        | CodeDeploy deploy configuration:                                                          |                                    |
|      |                                                                      | - EC2, on-premise: AllAtOnce, HalfAtATime, OneAtATime (Can be Blue/Green or **in-place**) |                                    |
|      |                                                                      | - Lambda, ECS: AllAtOnce, Canary, Linear                                                  |                                    |
| 4    | Build, test, deploy serverless app                                   | Serverles Application Model (SAM)                                                         |                                    |
| 5 ‚ùå | SAM template requires sections                                       | Transform & Resources                                                                     |                                    |
| 6 ‚ùå | Create Lambda function with CLI error InvalidParameterValueException | Invalid parameter: maybe a role can't be assumed                                          |                                    |
| 7 ‚ùå | ECS schedule task based on CPU/memory                                | ECS - Task placement strategy: binpack, spread, random                                    |                                    |

[API Gateway - Usage plan]: https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-api-usage-plans.html
[Step Function - Callback Pattern]: https://docs.aws.amazon.com/step-functions/latest/dg/callback-task-sample-sqs.html

## Domain 4: Troubleshooting and Optimization

| No    | Q                                                         | A                                                                                                   | Ref                                                        |
| ----- | --------------------------------------------------------- | --------------------------------------------------------------------------------------------------- | ---------------------------------------------------------- |
| 1     | Move session data to AWS, 100% CPU, HA                    | ElastiCache for Redis                                                                               |                                                            |
| 2     | sam local - Access denied                                 | 1. `aws configure --profile`; 2. `sam local invoke --profile`                                       |                                                            |
| 3     | Cost effective when using SQS                             | Long polling (config `ReceiveMessage` `WaitTime`)                                                   |                                                            |
| 4     | Record all changes to a DynamoDB table to another one     | DynamoDB Streams + Lambda (write to another DynamoDB table)                                         |                                                            |
| 5     | DynamoDB - Reduce queries                                 | DAX                                                                                                 |                                                            |
| 6 ‚ùå  | Serve private content from CloudFront                     | 1. Use signed-URL, sign-cookies                                                                     |                                                            |
|       |                                                           | 2. Use Lambda@Edge + Cognito üëâÔ∏è Authentication@Edge                                                |                                                            |
| 7 ‚ùå  | X-ray: How to debug?                                      | `_X_AMZN_TRACE_ID` + `AWS_XRAY_CONTEXT_MISSING`                                                     |                                                            |
| 8     | ECS store data in DynamoDB, how to verify each new items? | DynamoDB Strems + Lambda                                                                            |                                                            |
| 9     | API Gateway - 504                                         | 504 Gateway timeout -> Integration timeout after 30s                                                |                                                            |
| 10    | RDS - Too many connections                                | RDS Proxy                                                                                           |                                                            |
| 11    | API Gateway timeout - Which CW metrics to watch?          | `Latency`, `IntegrationLatency`                                                                     |                                                            |
| 12 ‚ùå | CloudFront HTTPS                                          | Viewer Protocol Policy: `Only HTTPS` or `Redirect HTTP to HTTPS`                                    |                                                            |
| 13    | CloudFront - end-to-end SSL                               | Viewer Protocol Policy, Origin Protocol Policy: HTTPS                                               |                                                            |
| 14 ‚ùå | DynamoDB Scan improve performance                         | - Default page size: 1MB (Max) -> Reduce page size                                                  |                                                            |
|       |                                                           | - Use `Query` instead of `Scan`                                                                     |                                                            |
| 15    | Capture IP in/out of an VPC                               | VPC Flow Log                                                                                        |                                                            |
| 16    | Elastic Beanstalk config for cron-job                     | `cron.yaml`                                                                                         |                                                            |
| 17    | DynamoDB - Fetch only some attributes                     | Use projection attributes                                                                           |                                                            |
| 18    | Lambda function download same big file                    | Use `/tmp`                                                                                          |                                                            |
| 19 ‚ùå | Use Lambda function inside a VPC                          | - By default, Lambda is public (has internet access)                                                |                                                            |
|       |                                                           | - After enable VPC for a Lambda function, it lose internet access,                                  |                                                            |
|       |                                                           | - If you require internet access for Lambda function:                                               |                                                            |
|       |                                                           | 1. Add a NATGW to VPC                                                                               |                                                            |
|       |                                                           | 2. Allow outbound traffic with security group                                                       |                                                            |
| 20 ‚ùå | X-Ray filter trace                                        | 1. Add `annotation` to record data used to group traces (indexed to used with `filter expression`)  |                                                            |
|       |                                                           | (`metadata` is extra data about data that isn't indexed )                                           |                                                            |
|       |                                                           | 2. Use `filter expression` to group traces in the console                                           |                                                            |
| 21    | App deploy with Elastic Beanstalk - Config X-Ray          | `.ebextensions/xray-daemon.config`                                                                  |                                                            |
| 22 ‚ùå | API Gateway: Lambda Proxy - 502 Bad Gateway               | In Lambda proxy integration, the backend Lambda function must return output according a JSON format | [Output format of a Lambda function for proxy integration] |

[Output format of a Lambda function for proxy integration]: https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html#api-gateway-simple-proxy-for-lambda-output-format
